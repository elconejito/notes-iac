version: '3.8'

services:
  reverse-proxy:
    image: nginx:stable-alpine
    container_name: reverse-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /opt/notes-stack/nginx:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /opt/notes-stack/certbot-www:/var/www/certbot:ro
    depends_on:
      joplin-server:
        condition: service_started
      trilium:
        condition: service_started

  trilium:
    image: triliumnext/notes:latest
    container_name: trilium-server
    restart: unless-stopped
    volumes:
      - {{ (enable_block_storage | bool) | ternary('/mnt/notes_data/trilium', '/opt/notes-stack/data/trilium') }}:/home/node/trilium-data

  joplin-db:
    image: postgres:16
    container_name: joplin-db
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: "{{ postgres_pwd }}"
      POSTGRES_USER: "joplin"
      POSTGRES_DB: "joplin"
    volumes:
      - {{ (enable_block_storage | bool) | ternary('/mnt/notes_data/joplin-db', '/opt/notes-stack/data/joplin-db') }}:/var/lib/postgresql/data

  joplin-server:
    image: joplin/server:latest
    container_name: joplin-server
    depends_on:
      joplin-db:
        condition: service_started
    environment:
      APP_BASE_URL: "https://{{ joplin_sub }}.{{ domain }}"
      DB_CLIENT: "pg"
      POSTGRES_DATABASE: "joplin"
      POSTGRES_USER: "joplin"
      POSTGRES_PASSWORD: "{{ postgres_pwd }}"
      POSTGRES_HOST: "joplin-db"
      STORAGE_DRIVER: "{% if enable_s3_storage | bool %}Type=S3; Region={{ s3_region }}; AccessKeyId={{ s3_key }}; SecretAccessKey={{ s3_secret }}; Bucket={{ s3_bucket }}; Endpoint=https://{{ s3_region }}.digitaloceanspaces.com{% else %}Type=Database{% endif %}"
{% if mailer_enabled | default(false) | bool %}
      MAILER_ENABLED: "1"
      MAILER_HOST: "{{ mailer_host }}"
      MAILER_PORT: "{{ mailer_port }}"
      MAILER_SECURE: "{{ mailer_secure }}"
      MAILER_USER: "{{ mailer_user }}"
      MAILER_PASSWORD: "{{ mailer_password }}"
      MAILER_FROM_EMAIL: "{{ mailer_from_email }}"
      MAILER_FROM_NAME: "{{ mailer_from_name }}"
{% endif -%}
